<!DOCTYPE html>
    <html lang="en">
      <head>
        <Set-Cookie: ACookieAvailableCrossSite; SameSite=None;Secure;>   
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=\, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <style>
          p.small { line-height: 1.1;}
          p.big {line-height: 1.8;}
        </style>
        <title>PA Data Display Stats</title> 
      </head>
        <body style="background-color:#242424;">
        <div id="airStations"><h2><font color=#8400a8>PURPLE AIR STATIONS NEAR NHBP</font></div>
        
        <script>
          var stationList = [44439, 2822, 5712, 43297, 7772, 37659];
          //Indicies to determine Air Quality Index based on PM 2.5 sensor readings
          //The AQI equation used is from USEPA at: https://forum.airnowtech.org/t/the-aqi-equation/169
          getAir(stationList);
          //setInterval(getAir, 100000);
          
          var airQualityIndex = (airValue) => {
            const c_low = [0, 12.1, 35.5, 55.5, 150.5, 250.5, 350.5], c_high = [12, 35.4, 55.4, 150.4, 250.4, 350.4, 500.4];  
            const aqi_low = [0, 51, 101, 151, 201, 301, 401], aqi_hi = [50, 100, 150, 200, 300, 400, 500];
            const aqi_fac = [4.17, 2.10, 2.46, 0.52, 0.99, 0.99, 0.66]
            const aqi_range = ["Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", 
                               "Hazardous", "Hazardous"];
            for (z in aqi_range) {
              if (airValue > c_high[z]) {
              console.log('Status = Current');
              } else { aqi_val = (aqi_fac[z] * (airValue - c_low[z]) + aqi_low[z]); 
                  aqi_val = Math.round(aqi_val); 
                  aqi = aqi_range[z];
                  console.log(`test function ${airValue}, ${aqi_val}, ${aqi}`);   
                  return {aqi_val, aqi};
                  }
              }
          };
          async function getAir(sta_list) {
            for (i in sta_list){
            //constructing url from Purple Air station ID value
            //multiple stations can be looped through via /json?show=<sta ID>
            //Rebuilding function to streamline on 3-10-20
            const api_url = ('https://www.purpleair.com/json?show=' + sta_list[i]); 
            const response = await fetch(api_url);
            const data = await response.json();
            let {Label, ID, PM2_5Value, Lat, Lon} = data.results[0];
            let sta_stats = (data.results[0].Stats).split(":");
            let pm25_1hour = (sta_stats[4]).substr(0, 4), pm25_24hour = (sta_stats[6]).substr(0, 4);     
            //Call AQI function to get current, 1 hour, and 24 hour AQI
            let currentAQI = airQualityIndex(PM2_5Value);  
            let oneHourAQI = airQualityIndex(pm25_1hour);
            let twentyFourHourAQI = airQualityIndex(pm25_24hour);
            let diff_val = Math.abs(data.results[0].PM2_5Value - data.results[1].PM2_5Value).toFixed(2);
            //assign values for html text display
            pageDisplay = () => {
            var para = document.createElement("P")
            para.innerText = "Purple Air Sensor Name: " + Label + "  " + "\n Station ID: " + ID 
            + "\n Current PM2.5: " + PM2_5Value + " Instant AQI : " + currentAQI.aqi_val + " Current Air Quality: " + currentAQI.aqi
            + "\n 1 Hour Average AQI: " + oneHourAQI.aqi_val + " 1 Hour Air Quality: " + oneHourAQI.aqi
            + "\n 24 Hour Average AQI: " + twentyFourHourAQI.aqi_val + " 24 Hour Air Quality: " + twentyFourHourAQI.aqi
            + "\n A/B Sensor Range PM2.5: " + diff_val;
            //Future figure out CSS to bold parts of the display text
            para.style.color = "#bfbfbf";   
            document.getElementById("airStations").appendChild(para);
            }
            pageDisplay();  
           };
          };
        </script> 
      </body>
    </html> 